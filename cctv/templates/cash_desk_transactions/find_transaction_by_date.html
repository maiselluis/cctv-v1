{% extends 'base.html'%}
 {% block title %} CCTV @ CRC | Find Transaction By Dates
 {% endblock%}
 {%block content_header%}
 <div class="app-content-header"> <!--begin::Container-->
  <div class="container-fluid"> <!--begin::Row-->
    <div class="row">
      <div class="col-sm-6">
        <h3 class="mb-0">CASH DESK TRANSACTIONS - FIND BY DATES</h3>
      </div>
      <div class="col-sm-6">
        <ol class="breadcrumb float-sm-end">
          <li class="breadcrumb-item"><a  href={% url 'index' %}>Home</a></li>
          <li class="breadcrumb-item active" aria-current="page"> <a  href={% url 'cash_desk_transactions-list' %}>Cash Desk Transactions</a> </li>
          <li class="breadcrumb-item">Find  by Dates</li>
         </ol>
      </div>
    </div> <!--end::Row-->
  </div> <!--end::Container-->
 </div>
 {%endblock%}

 {%block content%}

 <div class="card card-primary card-outline mb-4">
  <div style="overflow-x: auto;">
  <div class="card-header">
    
    <form method="get"  "> 
      <div class="container-fluid">
        <div class="row d-flex justify-content-end">   
         <div  class="col-sm-auto d-flex justify-content-end"> 
            {{ form.location}}
           </div> 
          <div  class="col-sm-auto d-flex justify-content-end align-self-center">                  
            <label class="card-title">{{ form.date_begin.label_tag }} </label>            
        </div> 
        <div  class="col-sm-auto d-flex justify-content-end"> 
        {{ form.date_begin}}
        </div> 
        <div  class="col-sm-auto d-flex justify-content-end align-self-center">     
          <label class="card-title">{{ form.date_end.label_tag }}</label> 
        </div> 
        <div  class="col-sm-auto d-flex justify-content-end">     
          {{ form.date_end }}
        </div> 
        <div  class="col-sm-auto">     
          <button class="btn btn-primary"  type="submit"> Find</button>               
        
        </div>   
        <div class="col-sm-auto">
                       
          <button class="btn btn-outline-dark bi-filetype-pdf" data-url="{% url 'transaction_view' %}" type="button"   onclick="openReport(this)">PDF</button>
        
        </div>                      
    
      </div>                  
      </div>                                                  
      
    </form>  
       
</div>
  </div>
<div style="overflow-x: auto;">
     <div class="card-body">         


       <h2>Results:</h2>  
            
       <table class="table table-bordered table-hover table-sm" id="transactionsbydate" >
           <thead>
             <tr >       
               <th>Date</th>
               <th>Time</th>
               <th>Cashier Location </th>
               <th>Account Type</th>  
               <th>Customer</th>                
               <th>Token</th>
               <th>TTD</th>                            
               <th> USD </th>
               <th> EURO </th>
               <th> GBP </th>
               <th> CAD </th>
               <th> Employee </th>
               <th>Machine No</th>
               <th> Autorized by </th> 
               <th>Branch</th>        
              
              </tr>
           </thead>   
         
      
           <tfoot>
            <tr>
                <th>Total</th>
                <th colspan="5"></th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
               
                <th colspan="4"></th>
                
                
            </tr>
        </tfoot>
         </table>
        
       

     </div>
     <div class="card-footer">
       
      <a class="btn btn-secondary mb-2 bi-chevron"  href="{% url 'cash_desk_transactions-list' %}" > <i class="bi bi-arrow-left"> </i> Back</a> 
           
       
          </div>
</div>
  


     <script>
$(document).ready(function() {

  $.fn.dataTable.moment('DD-MM-YYYY'); // Para la fecha
  $.fn.dataTable.moment('HH:mm');     // Para la hora

    let table = $('#transactionsbydate').DataTable({
        processing: true,
        serverSide: true,
        ajax: {
            url: '{% url "transactions-by-day" %}',
            type: 'GET',
            data: function(d) {
                d.date_begin = $('#id_date_begin').val();
                d.date_end = $('#id_date_end').val();
            },
            error: function(xhr, error, thrown) {
                console.error("AJAX Error:", xhr.responseText);
            }
        },
        language: {
           processing: "<span>Loading data...</span>"
        },
        order: [[0, "desc"],[2, "desc"]],
          
        columns: [
             { data: "date", "render": function(data, type, row) {
                       return moment(data, "YYYY-MM-DD").format("DD-MM-YYYY");
                   }
               },
               { data: "time", "render": function(data, type, row) {
                       return moment(data, "HH:mm:ss").format("HH:mm");
                   }
               },
            { data: 'area_cashier' },
            { data: 'account_type' },
            { data: 'customer' },
            { data: 'token' },
            { data: 'tt_dolar' },
            { data: 'usd_dolar' },
            { data: 'euro_dolar' },
            { data: 'gbp_dolar' },
            { data: 'cad_dolar' },
            { data: 'employee' },
            { data: 'machine_no' },
            { data: 'autorized_by' },
            { data: 'location' }
        ],

        oLanguage: {
                      oPaginate: {
                        sNext: 'Next <i class="fas fa-angle-double-right"></i>',
                        sPrevious: '<i class="fas fa-angle-double-left"></i> Previous',
                        sFirst: '<i class="fas fa-angle-double-left"></i> First',
                        sLast: '<i class="fas fa-angle-double-left"></i> Last',

                      }
          },
          "responsive": true,
          searchDelay:300,
        
        footerCallback: function (row, data, start, end, display) {
            var api = this.api();

            // Función para convertir a número
            var intVal = function (i) {
                return typeof i === 'string'
                    ? i.replace(/[\$,]/g, '') * 1
                    : typeof i === 'number'
                    ? i
                    : 0;
            };

            // Calcular totales por columna
            var totalUSD = api
                .column(7)
                .data()
                .reduce(function (a, b) {
                    return intVal(a) + intVal(b);
                }, 0);

            var totalEuro = api
                .column(8)
                .data()
                .reduce(function (a, b) {
                    return intVal(a) + intVal(b);
                }, 0);

            var totalTT = api
                .column(6)
                .data()
                .reduce(function (a, b) {
                    return intVal(a) + intVal(b);
                }, 0);

            var totalCAD = api
                .column(10)
                .data()
                .reduce(function (a, b) {
                    return intVal(a) + intVal(b);
                }, 0);
                var totalGBP = api
                .column(9)
                .data()
                .reduce(function (a, b) {
                    return intVal(a) + intVal(b);
                }, 0);

            // Mostrar totales en el footer
            $(api.column(7).footer()).html(totalUSD.toFixed(2));
            $(api.column(8).footer()).html(totalEuro.toFixed(2));
            $(api.column(6).footer()).html(totalTT.toFixed(2));
            $(api.column(10).footer()).html(totalCAD.toFixed(2));
            $(api.column(9).footer()).html(totalGBP.toFixed(2));
        },

        
    });

    

    $('#id_date_begin, #id_date_end').on('change', function () {
        table.ajax.reload();
    });

   
});



 
</script> 

<script>
  function openReport(button) {
  // Obtén la URL base del atributo data-url
   const baseUrl = button.getAttribute('data-url');
 
   // Obtén los valores de los campos de fecha
   const dateBegin  = document.querySelector('[name="date_begin"]').value;
   const dateEnd = document.querySelector('[name="date_end"]').value;
   const location = document.querySelector('[name="location"]').value;
 
 
   // Construye la URL con los parámetros
   const fullUrl = `${baseUrl}?location=${location}&date_begin=${encodeURIComponent(dateBegin)}&date_end=${encodeURIComponent(dateEnd)}`;
 
   // Abre la URL en una nueva ventana o pestaña
   window.open(fullUrl, '_blank');
 }
    </script>

  
 {% endblock %}